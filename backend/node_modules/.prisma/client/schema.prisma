generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  nombre       String
  email        String    @unique
  passwordHash String
  rol          String    @default("USER") // USER, ADMIN, TIME_CONTROLLER
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  lastLogin    DateTime?

  // Relaciones
  gameSessions    GameSession[]
  gamePermissions UserGamePermissions[]
}

model Team {
  id        Int      @id @default(autoincrement())
  nombre    String
  logo      String?
  players   Player[]
  homeGames Game[]   @relation("HomeTeam")
  awayGames Game[]   @relation("AwayTeam")
}

model Player {
  id               Int               @id @default(autoincrement())
  nombre           String
  apellido         String
  numero           Int
  posicion         String
  teamId           Int
  team             Team              @relation(fields: [teamId], references: [id])
  stats            PlayerGameStats[]
  substitutionsIn  Substitution[]    @relation("PlayerIn")
  substitutionsOut Substitution[]    @relation("PlayerOut")
  activeInGames    Game[]            @relation("ActivePlayers")
}

model Event {
  id          Int      @id @default(autoincrement())
  nombre      String
  fechaInicio DateTime
  fechaFin    DateTime
  games       Game[]
}

model Game {
  id         Int      @id @default(autoincrement())
  eventId    Int
  event      Event    @relation(fields: [eventId], references: [id])
  teamHomeId Int
  teamAwayId Int
  teamHome   Team     @relation("HomeTeam", fields: [teamHomeId], references: [id])
  teamAway   Team     @relation("AwayTeam", fields: [teamAwayId], references: [id])
  fecha      DateTime
  estado     String
  gameTime   Int      @default(0)
  homeScore  Int      @default(0)
  awayScore  Int      @default(0)

  // Quarter management
  currentQuarter Int     @default(1)
  quarterLength  Int     @default(720) // Quarter length in seconds (12 minutes = 720 seconds)
  totalQuarters  Int     @default(4) // Total quarters in regulation
  overtimeLength Int     @default(300) // Overtime length in seconds (5 minutes = 300 seconds)
  quarterTime    Int     @default(0) // Current quarter time in seconds
  isOvertime     Boolean @default(false) // Is game in overtime

  // Información del creador del juego
  createdBy Int? // ID del usuario que creó el juego

  stats         PlayerGameStats[]
  substitutions Substitution[]
  activePlayers Player[]          @relation("ActivePlayers")

  // Nuevas relaciones para sistema de usuarios
  gameSessions    GameSession[]
  userPermissions UserGamePermissions[]
}

model PlayerGameStats {
  id                    Int     @id @default(autoincrement())
  gameId                Int
  playerId              Int
  puntos                Int
  rebotes               Int
  asistencias           Int
  robos                 Int
  tapones               Int
  tirosIntentados       Int
  tirosAnotados         Int
  tiros3Intentados      Int
  tiros3Anotados        Int
  tirosLibresIntentados Int     @default(0)
  tirosLibresAnotados   Int     @default(0)
  minutos               Int
  plusMinus             Int
  perdidas              Int     @default(0)
  faltasPersonales      Int     @default(0) // Total personal fouls
  faltasQ1              Int     @default(0) // Personal fouls in Q1
  faltasQ2              Int     @default(0) // Personal fouls in Q2
  faltasQ3              Int     @default(0) // Personal fouls in Q3
  faltasQ4              Int     @default(0) // Personal fouls in Q4
  faltasOT              Int     @default(0) // Personal fouls in overtime
  isStarter             Boolean @default(false) // Track if player was a starter
  puntosQ1              Int     @default(0) // Points scored in Q1
  puntosQ2              Int     @default(0) // Points scored in Q2
  puntosQ3              Int     @default(0) // Points scored in Q3
  puntosQ4              Int     @default(0) // Points scored in Q4
  puntosOT              Int     @default(0) // Points scored in overtime
  game                  Game    @relation(fields: [gameId], references: [id], onDelete: Cascade)
  player                Player  @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([gameId, playerId])
}

model Substitution {
  id          Int      @id @default(autoincrement())
  gameId      Int
  playerInId  Int
  playerOutId Int
  timestamp   DateTime
  gameTime    Int
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerIn    Player   @relation("PlayerIn", fields: [playerInId], references: [id], onDelete: Cascade)
  playerOut   Player   @relation("PlayerOut", fields: [playerOutId], references: [id], onDelete: Cascade)
}

// Nuevos modelos para sistema de usuarios y permisos
model GameSession {
  id       Int       @id @default(autoincrement())
  gameId   Int
  userId   Int
  joinedAt DateTime  @default(now())
  leftAt   DateTime?
  isActive Boolean   @default(true)
  socketId String?

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
}

model UserGamePermissions {
  id     Int @id @default(autoincrement())
  gameId Int
  userId Int

  // Permisos específicos
  canEditPoints        Boolean @default(false)
  canEditRebounds      Boolean @default(false)
  canEditAssists       Boolean @default(false)
  canEditSteals        Boolean @default(false)
  canEditBlocks        Boolean @default(false)
  canEditTurnovers     Boolean @default(false)
  canEditShots         Boolean @default(false)
  canEditFreeThrows    Boolean @default(false)
  canEditPersonalFouls Boolean @default(false)

  // Permisos de control del juego (solo para TIME_CONTROLLER)
  canControlTime       Boolean @default(false)
  canMakeSubstitutions Boolean @default(false)
  canEndQuarter        Boolean @default(false)
  canSetStarters       Boolean @default(false)

  // Permisos administrativos
  canManagePermissions Boolean @default(false)
  canViewAllStats      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int? // ID del usuario que asignó estos permisos

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
}
